# CoinChange Technical Documentation

> Audience: developers, DevOps, security auditors, architects  
> Last updated: 2025-06-30

---

## 1   System Overview
CoinChange is split into two independently deployable modules:

| Module   | Purpose                                       | Artifact        |
|----------|-----------------------------------------------|-----------------|
| **Backend** | Secure user, wallet & order API            | `backend-0.0.1-SNAPSHOT.jar` |
| **Frontend** | SPA for trading UI + charts               | `/dist` static bundle |

All traffic is stateless; the backend merely validates JWTs, fetches quotes from Coinbase if needed and persists domain data in PostgreSQL.

---

## 2   Detailed Architecture

### 2.1  Backend Layering

Controller → Service → Repository → Database ⇄ Mapper (MapStruct)

* **Controller** – DTO-based REST endpoints, input validation (Jakarta Bean Validation)
* **Service** – transactional business logic, idempotency, caching
* **Repository** – Spring Data JPA
* **Mapper** – Generates DTO⇄Entity conversions

### 2.2  Asynchronous Tasks
| Task                                  | Schedule     | Notes                                               |
|---------------------------------------|--------------|-----------------------------------------------------|
| checkAndProcessPendingTransactionsJob | every 60 sec | Regularly checks and processes pending limit orders |

### 2.3  Caching
| Task               | Cache validity | Notes                                                  |
|--------------------|----------------|--------------------------------------------------------|
| getCoinStats       | */1 sec        | Caching of all requests to `/products/<BTC-USD>/stats` |

---

## 3   Database Schema (ER Diagram)

USERS {
id PK, username UNIQUE, email UNIQUE, password,
created_at, updated_at, valid_to
}

ROLES {
id PK, name UNIQUE, description
}

OPERATIONS {
id PK, name UNIQUE, description
}

CURRENCIES {
id PK, code UNIQUE, name, color, is_active, type
}

FEE_CATEGORIES {
id PK, category UNIQUE, fee_rate
}

TRANSACTIONS {
id PK,
user_id FK → users(id),
sold_currency_id FK → currencies(id),
bought_currency_id FK → currencies(id),
amount_sold, amount_bought,
transaction_fee_currency_id FK → currencies(id),
transaction_fee_amount,
converted_fee_currency_id FK → currencies(id),
converted_fee_amount,
fee_category_id FK → fee_categories(id),
conversion_rate_after_fees,
transaction_type_enum,
created_at, processed_at, cancelled_at,
external_reference, note
}

-- Junction tables
USER_ROLES { user_id FK, role_id FK }
ROLE_OPERATIONS { role_id FK, operation_id FK }

**Actual relationships:**
* **users 1:N user_roles N:1 roles**
* **roles 1:N role_operations N:1 operations**
* **transactions N:1 users**
* **transactions N:1 currencies (4× different FKs)**
* **transactions N:1 fee_categories**

**Enums:**
* CurrencyTypeEnum: FIAT='F', CRYPTO='C'
* FeeCategoryEnum: A, B, C, D, E, F
* TransactionTypeEnum: DEPOSIT, WITHDRAWAL, CONVERSION
---

## 4   Security Model

| Concern          | Implementation                                             |
|------------------|------------------------------------------------------------|
| AuthN            | `/api/auth/login` issues 60 min access JWT |
| AuthZ            | `@PreAuthorize("hasRole('ADMIN')")` / Ant Matchers         |
| Passwords        | BCrypt 12 rounds                                           |
| CSRF             | Disabled (pure JSON API, JWT + `SameSite=Strict`)          |
| Secrets          | Inject via Docker secrets or Kubernetes Secrets            |

---

## 5   API & Data Contracts
* Full OpenAPI 3 spec generated by springdoc-openapi `@Operation` annotations
* DTOs live in openapi autogenerated folders and `backend/.../dto`
* All apis are automatically generated from yaml files stored in /api folder. From these files both backend and frontend apis are generated including all DTOs etc (so these yaml files are single point of truth shared with backend and frontend).

---

## 6   Testing Strategy
No tests implemented

---

## 7   Logging & Monitoring
* **Backend** – Logback JSON to stdout → logs stored in /logs folder

---

## 8   External API Integration

### Coinbase Exchange API
* **Service:** CoinbaseExchangeServiceImpl
* **Endpoint:** `/products/{productId}/stats`
* **Cache:** @Cacheable("coinStats") with 1 second expiry
* **Supported pairs:** BTC-USD, ETH-USD, EURC-USDC, etc.

### Conversion Logic
* **FIAT-FIAT:** EUR-USD via EURC-USDC pair
* **CRYPTO-FIAT:** Direct Coinbase call
* **FIAT-CRYPTO:** Inverse calculation from Coinbase rates

### Business Logic Details

#### Two Trading Types
1. **Simple Trading:** Immediate execution at current market rate
2. **Advanced Trading:** Pending orders until target rate is reached

#### Fee Processing
* Calculation: `conversionRate * feeCategory.feeRate`
* Fee conversion to default currency (EUR)
* Storage in `converted_fee_amount`

#### Scheduled Jobs
* Every 60 seconds check for pending transactions
* Auto-processing when target rate is reached


